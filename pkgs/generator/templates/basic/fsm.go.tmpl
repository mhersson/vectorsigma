// The code is generated by VectorSigma. DO NOT EDIT.
package {{ .Package }}

const (
{{ range $state, $val := .FSM.States }}
	{{ $state }} StateName = "{{ $state }}"
{{- end }}

{{ range .FSM.ActionNames }}
	{{ . }} ActionName = "{{ . }}"
{{- end }}

{{ range .FSM.GuardNames }}
	{{ . }} GuardName = "{{ . }}"
{{- end }}
)

var (
	AllGuards  = Guards{}
	AllActions = Actions{}
)

type (
	StateName  string
	ActionName string
	GuardName  string
	Guards     map[GuardName]Guard
	Actions    map[ActionName]Action
	States     map[StateName]State
)

type GuardedTransistion struct {
	Name   GuardName
	Target StateName
}

type StateAction struct {
	Name       ActionName
	Parameters []string
}

type State struct {
	Actions []StateAction
	Guards  []GuardedTransistion
}

type Action interface {
	Execute(ctx *Context, state *ExtendedState, parameters ...string) error
}

type Guard interface {
	Evaluate(state *ExtendedState) bool
}

type StateMachine struct {
	States       States
	InitialState StateName
}

type Runner struct {
	Context *Context
	State   *ExtendedState
	Current StateName
	Actions Actions
	Guards  Guards
	StateMachine
}

func (r *Runner) Run() {
	r.Current = r.InitialState

	for {
		r.Context.Log.Info("Current state", "state", r.Current)

		s, ok := r.States[r.Current]
		if !ok {
			panic("invalid state")
		}

		for _, ac := range s.Actions {
			err := r.Actions[ac.Name].Execute(r.Context, r.State, ac.Parameters...)
			if err != nil {
				r.State.Error = err.Error()
			}
		}

		var nextState StateName

		for _, gu := range s.Guards {
			if gu.Name == "" || r.Guards[gu.Name].Evaluate(r.State) {
				nextState = gu.Target

				break
			}
		}

		if nextState == FinalState {
			if r.State.Error != "" {
				r.Context.Log.Error(r.State.Error, "state", r.Current)
			}

			break
		}

		r.Current = nextState
	}
}

func New() *StateMachine {
	return &StateMachine{
		InitialState: {{ .FSM.InitialState }},
		States: States{
		{{- range $name, $state := .FSM.States }}
			{{ $name }}: {
				{{- range $action := $state.Actions }}
				Actions: []StateAction{
					{
						Name: {{ $action.Name }},
						Parameters: []string{ {{- $action.Params }}},
					},
				},
				{{- end }}
				Guards: []GuardedTransistion{
					{{- range $transition := $state.Transitions }}
					{{- if eq $transition.Guard "" }}
					{Name: "", Target: {{ $transition.Target }}},
					{{- else }}
					{Name: {{ $transition.Guard }} , Target: {{ $transition.Target }}},
					{{- end }}
					{{- end }}
				},
			},
	{{- end }}
		},
	}
}
